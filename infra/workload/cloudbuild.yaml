steps:
   # Initialize Terraform with upgrade to resolve provider version conflicts
   - name: 'hashicorp/terraform:1.9.0'
     args: ['init', '-upgrade']
     dir: 'infra/workload'

   # Check Terraform formatting
   - name: 'hashicorp/terraform:1.9.0'
     args: ['fmt', '-check']
     dir: 'infra/workload'

   # Validate Terraform configuration
   - name: 'hashicorp/terraform:1.9.0'
     args: ['validate']
     dir: 'infra/workload'

   # Security scan with tfsec
   - name: 'tfsec/tfsec'
     args: ['.']
     dir: 'infra/workload'

   # Plan Terraform changes
   - name: 'hashicorp/terraform:1.9.0'
     args: ['plan', '-out=tfplan']
     dir: 'infra/workload'

   # Apply Terraform changes
   - name: 'hashicorp/terraform:1.9.0'
     args: ['apply', '-auto-approve', 'tfplan']
     dir: 'infra/workload'

   # Output deployment information
   - name: 'hashicorp/terraform:1.9.0'
     args: ['output']
     dir: 'infra/workload'

# Options for Cloud Build
options:
 logging: CLOUD_LOGGING_ONLY

# Timeout for the build
timeout: '1200s'